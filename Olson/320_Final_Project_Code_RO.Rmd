---
title: "320 Final Project"
author: "Belle Schmidt and Rachael Olson"
date: "2025-11-12"
output: html_document
---

```{r}
library(readr)
library(dplyr)
library(pracma)
library(readr)

nfl_team_stats_2002_2024 <- read_csv("nfl_team_stats_2002-2024.csv")


#View(nfl_team_stats_2002_2024)

# nfl_team_stats_2002_2024
```


```{r}
nfl_team_stats_2002_2024 <- nfl_team_stats_2002_2024 %>% 
  mutate(away_win_margin = score_away - score_home,
         home_win_margin = score_home - score_away) |> 
  select(season, week, home, away, home_win_margin, score_away, score_home) |> 
  mutate(home = ifelse(home == "Bills", "T1", ifelse(home == "Dolphins", "T2", ifelse(home == "Patriots", "T3", ifelse(home == "Jets", "T4", ifelse(home == "Ravens", "T5", ifelse(home == "Bengals", "T6", ifelse(home == "Browns", "T7", ifelse(home == "Steelers", "T8", ifelse(home == "Texans", "T9", ifelse(home == "Texans", "T9", ifelse(home == "Colts", "T10", ifelse(home == "Jaguars", "T11", ifelse(home == "Titans", "T12", ifelse(home == "Broncos", "T13", ifelse(home == "Chiefs", "T14", ifelse(home == "Raiders", "T15", ifelse(home == "Chargers", "T16", ifelse(home == "Cowboys", "T17", ifelse(home == "Giants", "T18", ifelse(home == "Eagles", "T19", ifelse(home == "Commanders", "T20", ifelse(home == "Bears", "T21", ifelse(home == "Lions", "T22", ifelse(home == "Packers", "T23", ifelse(home == "Vikings", "T24", ifelse(home == "Falcons", "T25", ifelse(home == "Panthers", "T26", ifelse(home == "Saints", "T27", ifelse(home == "Buccaneers", "T28", ifelse(home == "Cardinals", "T29", ifelse(home == "Rams", "T30", ifelse(home == "49ers", "T31", "T32"))))))))))))))))))))))))))))))))) |> 
  mutate(away = ifelse(away == "Bills", "T1", ifelse(away == "Dolphins", "T2", ifelse(away == "Patriots", "T3", ifelse(away == "Jets", "T4", ifelse(away == "Ravens", "T5", ifelse(away == "Bengals", "T6", ifelse(away == "Browns", "T7", ifelse(away == "Steelers", "T8", ifelse(away == "Texans", "T9", ifelse(away == "Texans", "T9", ifelse(away == "Colts", "T10", ifelse(away == "Jaguars", "T11", ifelse(away == "Titans", "T12", ifelse(away == "Broncos", "T13", ifelse(away == "Chiefs", "T14", ifelse(away == "Raiders", "T15", ifelse(away == "Chargers", "T16", ifelse(away == "Cowboys", "T17", ifelse(away == "Giants", "T18", ifelse(away == "Eagles", "T19", ifelse(away == "Commanders", "T20", ifelse(away == "Bears", "T21", ifelse(away == "Lions", "T22", ifelse(away == "Packers", "T23", ifelse(away == "Vikings", "T24", ifelse(away == "Falcons", "T25", ifelse(away == "Panthers", "T26", ifelse(away == "Saints", "T27", ifelse(away == "Buccaneers", "T28", ifelse(away == "Cardinals", "T29", ifelse(away == "Rams", "T30", ifelse(away == "49ers", "T31", "T32"))))))))))))))))))))))))))))))))) |> 
  filter(week %in% 1:18)


Season24 <- nfl_team_stats_2002_2024 %>% 
  filter(season == 2024)

Season23 <- nfl_team_stats_2002_2024 |> 
  filter(season == 2023)

Season22 <- nfl_team_stats_2002_2024 |> 
  filter(season == 2022)

Season21 <- nfl_team_stats_2002_2024 |> 
  filter(season == 2021)

# Thru_Week_6 <- Season24 %>% 
#   filter(week < 6) %>% 
#   dplyr::select(-season, -week, -date, -time_et)
# 
# Thru_Week_6
# 
# Away_Stats <- Thru_Week_6 %>% 
#   group_by(away) %>% 
#   summarise(points_allowed_away = sum(score_home),
#             yards_allowed_away = sum(yards_home),
#             sacks_away = sum(sacks_num_away),
#             turnovers_away = sum(fumbles_away) + sum(interceptions_away),
#             num_away_games = n())
# 
# Home_Stats <- Thru_Week_6 %>% 
#   group_by(home) %>% 
#   summarise(points_allowed_home = sum(score_away),
#             yards_allowed_home = sum(yards_away),
#             sacks_home = sum(sacks_num_home),
#             turnovers_home = sum(fumbles_home) + sum(interceptions_home),
#             num_home_games = n())
# 
# 
# ThruWeek6Totals <- full_join(Away_Stats, Home_Stats, join_by(away == home))

# Season24 %>% 
#   dplyr::select(-season, -date, -time_et, -first_downs_away, -first_downs_home, -first_downs_from_passing_away, -first_downs_from_passing_home, -first_downs_from_rushing_away, -first_downs_from_rushing_home, -first_downs_from_penalty_away, -first_downs_from_penalty_home, -third_down_comp_away, -third_down_comp_home, -third_down_att_away, -third_down_att_home, -fourth_down_att_away, -fourth_down_att_home, -fourth_down_comp_away, -fourth_down_comp_home, -plays_away, -plays_home, -drives_away, -drives_home, -pass_comp_away, -pass_comp_home)

#View(Season24)
```

# Pre Information

AFC East: 
T1 = Bills
T2 = Dolphins
T3 = Patriots
T4 = Jets

AFC North: 
T5 = Ravens
T6 = Bengals
T7 = Browns
T8 = Steelers

AFC South: 
T9 = Texans
T10 = Colts 
T11 = Jaguars
T12 = Titans

AFC West: 
T13 = Broncos
T14 = Chiefs 
T15 = Raiders
T16 = Chargers

NFC East: 
T17 = Cowboys
T18 = Giants
T19 = Eagles
T20 = Commanders

NFC North: 
T21 = Bears
T22 = Lions
T23 = Packers
T24 = Vikings

NFC South: 
T25 = Falcons
T26 = Panthers
T27 = Saints
T28 = Buccaneers

NFC West: 
T29 = Cardinals
T30 = Rams
T31 = 49ers
T32 = Seahawks

# Functions 

# Comparing Rankings 

```{r}

# Exact Comparison
Comparison <- function(ranking1, ranking2){
  ranking1 <- ranking1 |> 
  select(Team) |> 
  rename(Ranking_1 = Team)

  ranking2 <- ranking2 |> 
  select(Team) |> 
  rename(Ranking_2 = Team)

  Ranking_comparison <- cbind(ranking1, ranking2)|> 
    mutate(differs = Ranking_1 != Ranking_2)
  
  return(Ranking_comparison)
}

# Comparison within Three Places
move_3_comparison <- function(ranking1, ranking2) {
  ranking1 <- ranking1 |> #team names and rank nums
    dplyr::select(Team) |> 
    dplyr::mutate(Ranking_1 = dplyr::row_number())

  ranking2 <- ranking2 |> 
    dplyr::select(Team) |> 
    dplyr::mutate(Ranking_2 = dplyr::row_number())
  
  #join rankings by Team
  Ranking_comparison <- dplyr::left_join(ranking1, ranking2, by = "Team")

  #team has or has not moved more than 3 spots
  Ranking_comparison <- Ranking_comparison |>
    dplyr::mutate(moved_3_or_less = abs(Ranking_1 - Ranking_2) <= 3)

  return(Ranking_comparison)
}
```

# Massey's Method General: Least Squares

```{r}
# Function That Makes Initial T Matrix
modify_matrix <- function(input_matrix, data) {
  for (i in 1:nrow(data)){
    col <- data$home[i]
    col_index <- as.numeric(sub("T","", data$home[i]))
    input_matrix[i, col_index] <- 1
    col2 <- data$away[i]
    col_index2 <- as.numeric(sub("T","", data$away[i]))
    input_matrix[i, col_index2] <- -1
    
  
  }
  
  return(input_matrix)
}

# Used For Fixing The Linear Dependence Issue
modify_matrix2 <- function(input_matrix, row) {
  for (i in 1:ncol(input_matrix)){
    input_matrix[row, i] <- 1
    
}
  
  return(input_matrix)
    
}
```

# Keener's Method 

```{r}
A_matrix <- function(input_data) {
  zeros <- matrix(0, ncol = 32, nrow = 32)
  for (i in 1:(nrow(input_data))){
    if ((input_data$home[i] %in% 1:4 && input_data$away[i] %in% 1:4) |
        (input_data$home[i] %in% 5:8 && input_data$away[i] %in% 5:8) |
        (input_data$home[i] %in% 9:12 && input_data$away[i] %in% 9:12) |
        (input_data$home[i] %in% 13:16 && input_data$away[i] %in% 13:16) |
        (input_data$home[i] %in% 17:20 && input_data$away[i] %in% 17:20) |
        (input_data$home[i] %in% 21:24 && input_data$away[i] %in% 21:24) |
        (input_data$home[i] %in% 25:28 && input_data$away[i] %in% 25:28) |
        (input_data$home[i] %in% 29:32 && input_data$away[i] %in% 29:32)){
       for (j in 1:nrow(input_data)){
         if (input_data$home[i] == input_data$away[j] && input_data$away[i] == input_data$home[j]){
           row_index <- input_data$home[i]
          # print(message("The two teams are in the same division. The home team in the first game is", row_index))
           col_index <- input_data$away[i]
           # print(message("The away team is", col_index))
           zeros[row_index, col_index] <- (input_data$score_home[i] + input_data$score_away[j] + 1) / (input_data$score_home[i] + input_data$score_away[i] + input_data$score_home[j] + input_data$score_away[j] + 2)
           # print(message("The aij is", zeros[row_index, col_index]))
           
           zeros[col_index, row_index] <- (input_data$score_away[i] + input_data$score_home[j] + 1) / (input_data$score_home[i] + input_data$score_away[i] + input_data$score_home[j] + input_data$score_away[j] + 2)
         #  print(message("The aji is", zeros[col_index, row_index]))
         }
       }
    }
    else{
    row_index <- input_data$home[i]
    col_index <- input_data$away[i]
    # print(message("These teams are not in the same division. The home team was", row_index))
    # print(message("The away team was", col_index))
    zeros[row_index,col_index] <- (input_data$score_home[i] + 1) / (input_data$score_home[i] + input_data$score_away[i] + 2)
    # print(message("The aij is", zeros[row_index,col_index]))
       zeros[col_index,row_index] <- (input_data$score_away[i] + 1) / (input_data$score_home[i] + input_data$score_away[i] + 2)
   #  print(message("The aji is", zeros[col_index,row_index]))
  }
  }
  return(zeros)
    
}

Skewing_Matrix <- function(input_matrix){
  for (i in 1:nrow(input_matrix)) {
    for (j in 1:ncol(input_matrix)) {
      if (input_matrix[i,j] == 0) {
        input_matrix[i,j] = 1/2
      }
      else{
      input_matrix[i, j] = (1/2) + (((sign(input_matrix[i,j] - (1/2)) * sqrt(abs(2* input_matrix[i,j] - 1))))/(2))
      }
    } 
  }
  return(input_matrix)
}
```

# Season 2024 

```{r}
Week_9_Least_Squares <-Season24 |> 
  mutate(week = as.numeric(week)) |> 
  filter(week < 10)
```

```{r}
NFL_End_Of_Season_Ranking <- data.frame(Team = c("Lions", "Chiefs", "Vikings", "Eagles","Bills", "Ravens", "Commanders", "Packers", "Chargers", "Broncos", "Texans", "Rams", "Steelers", "Seahawks", "Buccaneers", "Bengals", "Cardinals", "Falcons", "Colts", "Dolphins", "Cowboys", "49ers", "Panthers", "Bears", "Saints", "Jets", "Jaguars", "Raiders", "Patriots", "Browns", "Giants", "Titans"))

NFL_Playoff_Placing <- data.frame(Team = c("Eagles", "Chiefs", "Bills", "Commanders","Lions","Ravens","Rams", "Texans", "Buccaneers","Vikings","Chargers","Steelers","Packers","Broncos"))
```


## Least Squares Through Week 9

```{r}
Solutions_week9 <- as.matrix(Week_9_Least_Squares[, "home_win_margin"])

zeros_week9 <- matrix(0, ncol = 32, nrow = 138)

T_week9 <- modify_matrix(zeros_week9, Week_9_Least_Squares)

NewT_week9 <- t(T_week9)%*%T_week9

NewSolution_week9 <- t(T_week9)%*%Solutions_week9

LinearIndependence_week9 <- modify_matrix2(NewT_week9, 32)

NewSolution_week9[32, 1] <- 0

NFL_Rankings_Week9 <- solve(LinearIndependence_week9) %*% NewSolution_week9

Ranking_Least_SquaresWeek9 <- data.frame(Team = c("Bills", "Dolphins", "Patriots", "Jets", "Ravens", "Bengals", "Browns", "Steelers", "Texans", "Colts", "Jaguars", "Titans", "Broncos", "Chiefs", "Raiders", "Chargers", "Cowboys", "Giants", "Eagles", "Commanders", "Bears", "Lions", "Packers", "Vikings", "Falcons", "Panthers", "Saints", "Buccaneers", "Cardinals", "Rams", "49ers", "Seahawks"),
                         Ranking_Value = NFL_Rankings_Week9[,1]) |> 
  arrange(-Ranking_Value)

Ranking_Least_SquaresWeek9
```

## Least Squares Ranking Week 18

```{r}
Solutions_week18 <- as.matrix(Season24[, "home_win_margin"])

zeros_week18 <- matrix(0, ncol = 32, nrow = 272)

T_week18 <- modify_matrix(zeros_week18, Season24)

NewT_week18 <- t(T_week18)%*%T_week18

NewSolution_week18 <- t(T_week18)%*%Solutions_week18

LinearIndependence_week18 <- modify_matrix2(NewT_week18, 32)

NewSolution_week18[32, 1] <- 0

NFL_Rankings_Week18 <- solve(LinearIndependence_week18) %*% NewSolution_week18

Ranking_Least_SquaresWeek18 <- data.frame(Team = c("Bills", "Dolphins", "Patriots", "Jets", "Ravens", "Bengals", "Browns", "Steelers", "Texans", "Colts", "Jaguars", "Titans", "Broncos", "Chiefs", "Raiders", "Chargers", "Cowboys", "Giants", "Eagles", "Commanders", "Bears", "Lions", "Packers", "Vikings", "Falcons", "Panthers", "Saints", "Buccaneers", "Cardinals", "Rams", "49ers", "Seahawks"),
                         Ranking_Value = NFL_Rankings_Week18[,1]) |> 
  arrange(-Ranking_Value)

Ranking_Least_SquaresWeek18
```

# Week 9 Keener's Method Rankings

```{r}
Week9_For_Keener <- Week_9_Least_Squares |> 
  mutate(home = as.numeric(sub("T","", home)),
         away = as.numeric(sub("T","", away)))

Initial_Matrix_Week9 <- A_matrix(Week9_For_Keener) 

Matrix_Week9 <- Skewing_Matrix(Initial_Matrix_Week9)

eigen_Week9 <- eigen(Matrix_Week9)

team_ranking_week9 <- data.frame(Team = c("Bills", "Dolphins", "Patriots", "Jets", "Ravens", "Bengals", "Browns", "Steelers", "Texans", "Colts", "Jaguars", "Titans", "Broncos", "Chiefs", "Raiders", "Chargers", "Cowboys", "Giants", "Eagles", "Commanders", "Bears", "Lions", "Packers", "Vikings", "Falcons", "Panthers", "Saints", "Buccaneers", "Cardinals", "Rams", "49ers", "Seahawks"),
                         Ranking_Value = eigen_Week9$vectors[,1]) |> 
  arrange(-Ranking_Value)

team_ranking_week9
```

# Week 18 Keener's Method Rankingss

```{r}
Week18_For_Keener <- Season24 |> 
  mutate(home = as.numeric(sub("T","", home)),
         away = as.numeric(sub("T","", away)))

Initial_Matrix_Week18 <- A_matrix(Week18_For_Keener) 

Matrix_Week18 <- Skewing_Matrix(Initial_Matrix_Week18)

eigen_Week18 <- eigen(Matrix_Week18)

team_ranking_week18 <- data.frame(Team = c("Bills", "Dolphins", "Patriots", "Jets", "Ravens", "Bengals", "Browns", "Steelers", "Texans", "Colts", "Jaguars", "Titans", "Broncos", "Chiefs", "Raiders", "Chargers", "Cowboys", "Giants", "Eagles", "Commanders", "Bears", "Lions", "Packers", "Vikings", "Falcons", "Panthers", "Saints", "Buccaneers", "Cardinals", "Rams", "49ers", "Seahawks"),
                         Ranking_Value = eigen_Week18$vectors[,1]) |> 
  arrange(Ranking_Value)

team_ranking_week18 
```

# Comparing Like Models Week to Week

## Comparing Week 9 to Week 18 Keener's

```{r}
Comparing_Keeners <- Comparison(team_ranking_week9, team_ranking_week18)

Comparing_Keeners

Comparing_Keeners |> 
  count(differs)


Comparing_Keeners_3 <- move_3_comparison(team_ranking_week9, team_ranking_week18)

Comparing_Keeners_3

Comparing_Keeners_3 |> 
  count(moved_3_or_less)
```

## Comparing Week 9 to Week 18 Least Squares

```{r}
Comparing_Least_Squares <- Comparison(Ranking_Least_SquaresWeek9, Ranking_Least_SquaresWeek18)

Comparing_Least_Squares |> 
  count(differs)

Comparing_Least_Squares_3 <- move_3_comparison(Ranking_Least_SquaresWeek9, Ranking_Least_SquaresWeek18)

Comparing_Least_Squares_3

Comparing_Least_Squares_3 |> 
  count(moved_3_or_less)
```

# Comparing Same Weeks Model to Model

## Comparing Keener's Week 9 and Least Squares Week 9
```{r}
Week9_Comparisons <- Comparison(team_ranking_week9, Ranking_Least_SquaresWeek9)

Week9_Comparisons

Week9_Comparisons |> 
  count(differs)

Week9_Comparisons_3 <- move_3_comparison(team_ranking_week9, Ranking_Least_SquaresWeek9)

Week9_Comparisons_3

Week9_Comparisons_3 |> 
  count(moved_3_or_less)
```

## Comparing Keener's Week 18 and Least Sqaures Week 18

```{r}
Week18_Comparisons <- Comparison(team_ranking_week18, Ranking_Least_SquaresWeek18)

Week18_Comparisons

Week18_Comparisons |> 
  count(differs)

Week18_Comparisons_3 <- move_3_comparison(team_ranking_week18, Ranking_Least_SquaresWeek18)

Week18_Comparisons_3

Week18_Comparisons_3 |> 
  count(moved_3_or_less)
```


# Comparing Models With NFL Final Results

## Keener's Method vs NFL End of Season Rankings

### Week 9

```{r}
NFL_Rankings_Keeners_Week9 <- Comparison(NFL_End_Of_Season_Ranking, team_ranking_week9)

NFL_Rankings_Keeners_Week9

NFL_Rankings_Keeners_Week9 |> 
  count(differs)

NFL_Rankings_Keeners_Week9_3 <- move_3_comparison(NFL_End_Of_Season_Ranking, team_ranking_week9)

NFL_Rankings_Keeners_Week9_3

NFL_Rankings_Keeners_Week9_3 |> 
  count(moved_3_or_less)
```

### Week 18 

```{r}
NFL_Rankings_Keeners_Week18 <- Comparison(NFL_End_Of_Season_Ranking, team_ranking_week18)

NFL_Rankings_Keeners_Week18

NFL_Rankings_Keeners_Week18 |> 
  count(differs)

NFL_Rankings_Keeners_Week18_3 <- move_3_comparison(NFL_End_Of_Season_Ranking, team_ranking_week18)

NFL_Rankings_Keeners_Week18_3

NFL_Rankings_Keeners_Week18_3 |> 
  count(moved_3_or_less)
```

## Keener's Method vs Playoff Placing 

### Week 9

```{r}
top_14_ranking_week9 <- team_ranking_week9 |> 
  slice_head(n = 14)

playoff_placing_week9 <- Comparison(NFL_Playoff_Placing, top_14_ranking_week9)

playoff_placing_week9 |> 
  count(differs)

playoff_placing_week9_3 <- move_3_comparison(NFL_Playoff_Placing, top_14_ranking_week9)

playoff_placing_week9_3 |> 
  count(moved_3_or_less)

playoff_placing_week9_3
```

### Week 18

```{r}
top_14_ranking_week18 <- team_ranking_week18 |> 
  slice_head(n = 14)

top_14_ranking_week18

playoff_placing_week18 <- Comparison(NFL_Playoff_Placing, top_14_ranking_week18)

playoff_placing_week18 |> 
  count(differs)

playoff_placing_week18_3 <- move_3_comparison(NFL_Playoff_Placing, top_14_ranking_week18)

playoff_placing_week18_3 |> 
  count(moved_3_or_less)
```


## Least Squares vs NFL End of Season Rankings 

### Week 9

```{r}
NFL_Rankings_Least_Squares_Week9 <- Comparison(NFL_End_Of_Season_Ranking, Ranking_Least_SquaresWeek9)

NFL_Rankings_Least_Squares_Week9

NFL_Rankings_Least_Squares_Week9 |> 
  count(differs)

NFL_Rankings_Least_Squares_Week9_3 <- move_3_comparison(NFL_End_Of_Season_Ranking, Ranking_Least_SquaresWeek9)

NFL_Rankings_Least_Squares_Week9_3

NFL_Rankings_Least_Squares_Week9_3 |> 
  count(moved_3_or_less)
```

### Week 18 

```{r}
NFL_Rankings_Least_Squares_Week18 <- Comparison(NFL_End_Of_Season_Ranking, Ranking_Least_SquaresWeek18)

NFL_Rankings_Least_Squares_Week18

NFL_Rankings_Least_Squares_Week18 |> 
  count(differs)

NFL_Rankings_Least_Squares_Week18_3 <- move_3_comparison(NFL_End_Of_Season_Ranking, Ranking_Least_SquaresWeek18)

NFL_Rankings_Least_Squares_Week18_3

NFL_Rankings_Least_Squares_Week18_3 |> 
  count(moved_3_or_less)
```

## Least Squares vs Playoff Placing 

### Week 9

```{r}
top_14_ranking_least_squares_week9 <- Ranking_Least_SquaresWeek9 |> 
  slice_head(n = 14)

playoff_placing_least_squares_week9 <- Comparison(NFL_Playoff_Placing, top_14_ranking_least_squares_week9)

playoff_placing_least_squares_week9 |> 
  count(differs)

playoff_placing_least_squares_week9_3 <- move_3_comparison(NFL_Playoff_Placing, top_14_ranking_least_squares_week9)

playoff_placing_least_squares_week9_3 |> 
  count(moved_3_or_less)
```

### Week 18

```{r}
top_14_ranking_least_squares_week18 <- Ranking_Least_SquaresWeek18 |> 
  slice_head(n = 14)

top_14_ranking_least_squares_week18

playoff_placing_least_squares_week18 <- Comparison(NFL_Playoff_Placing, top_14_ranking_least_squares_week18)

playoff_placing_least_squares_week18 |> 
  count(differs)

playoff_placing_least_squares_week18_3 <- move_3_comparison(NFL_Playoff_Placing, top_14_ranking_least_squares_week18)

playoff_placing_least_squares_week18_3 |> 
  count(moved_3_or_less)
```
